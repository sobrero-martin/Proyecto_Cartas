@page "/juego/{PartidaId:int}"
@inject SesionUsuario Sesion
@inject IHttpServicio http
@inject HttpClient httpClient
@inject IJSRuntime js
@inject NavigationManager navHttp

<PageTitle>Partida</PageTitle>

<div class="partida">

    <div class="header">
        <div class="hp rival">
            @if(nombreRival != "")
            {
                <span>@nombreRival</span>
            }
            else
            {
                <span>Rival</span>
            }
            @if (vidaRival == 3)
            {
                <img src="@($"img/ui/3HP.png")" alt="Vida = @vidaRival" />
            }
            else if (vidaRival == 2)
            {
                <img src="@($"img/ui/2HP.png")" alt="Vida = @vidaRival" />
            }
            else if (vidaRival == 1)
            {
                <img src="@($"img/ui/1HP.png")" alt="Vida = @vidaRival" />
            }
            else
            {
                <img src="@($"img/ui/0HP.png")" alt="Vida = @vidaRival" />
            }

        </div>
    <div class="turno">
        @if (turnoActual != null)
        {
            <h3>Turno @turnoActual.Numero: @turnoActual.Fase</h3>
        }
        else
        {
            <h3>Cargando turno...</h3>
        }

    </div>
    <div class="hp jugador">
            @if (nombreJugador != "")
            {
                <span>@nombreJugador</span>
            }
            @if(Cementerio == 0)
            {
                <img src="@($"img/ui/3HP.png")" alt="Vida = @Cementerio"/>
            } else if(Cementerio == 1)
            {
                <img src="@($"img/ui/2HP.png")" alt="Vida = @Cementerio" />
            } else if(Cementerio == 2)
            {
                <img src="@($"img/ui/1HP.png")" alt="Vida = @Cementerio" />
            } else
            {
                <img src="@($"img/ui/0HP.png")" alt="Vida = @Cementerio" />
            }

    </div>
    </div>


@if(cartasJugador.Count == 0)
{
    <p>Cargando cartas...</p>
}
else
{

    <div class="tablero">
        <div class="campo" @onclick="@(() => ColocarCarta("Campo1"))">
            @foreach (var carta in cartasEnCampoRival.Where(c => c.Posicion == "Campo1"))
            {
                <Carta carta="carta" />
            }
        </div>
        <div class="campo" @onclick="@(() => ColocarCarta("Campo2"))">
            @foreach (var carta in cartasEnCampoRival.Where(c => c.Posicion == "Campo2"))
            {
                <Carta carta="carta" />
            }
        </div>
        <div class="campo" @onclick="@(() => ColocarCarta("Campo3"))">
            @foreach (var carta in cartasEnCampoRival.Where(c => c.Posicion == "Campo3"))
            {
                <Carta carta="carta" />
            }
        </div>
    </div>
    <div class="separadorTablero">
            <span>VS</span>
    </div>
    <div class="tablero">
        <div class="campo" @onclick="@(() => ColocarCarta("Campo1"))">
            @foreach (var carta in cartasEnCampo.Where(c => c.Posicion == "Campo1"))
            {
                <Carta carta="carta" />
            }
        </div>
        <div class="campo" @onclick="@(() => ColocarCarta("Campo2"))">
            @foreach (var carta in cartasEnCampo.Where(c => c.Posicion == "Campo2"))
            {
                <Carta carta="carta" />
            }
        </div>
        <div class="campo" @onclick="@(() => ColocarCarta("Campo3"))">
            @foreach (var carta in cartasEnCampo.Where(c => c.Posicion == "Campo3"))
            {
                <Carta carta="carta" />
            }
        </div>
    </div>

    <div class="cementerio">
        <p>Cementerio: @Cementerio</p>
    </div>

    <div class="mazo">
        <p>Cartas: @Mazo</p>
    </div>
    
    <div class="mano">
        <div class="cartasMano">
        @foreach (var carta in cartasMano)
        {
            <Carta carta="carta" OnCartaClick="SeleccionarCarta"/>
        }
        </div>
        <div class="botonesMano">
        <button class="btn btn-primary" @onclick="RobarCarta">Robar Carta</button>

        <button class="btn btn-secondary" @onclick="Actualizar">Actualizar</button>

        <button class="btn btn-danger" @onclick="PresionoTerminarTurno">@btnTerminarTurnoText</button>

        <button class="btn btn-danger" @onclick="CancelarPartida">Rendirse</button>
        </div>
    </div>

    @if (popUpRobar)
    {
    <div style="position: fixed; color:#26282B ;top: 50%; right: 50%; background-color: lightblue; padding: 15px; border: 1px solid blue; border-radius: 5px; z-index: 1000;">
        Ya has robado una carta este turno.
        <button class="btn btn-danger" @onclick="() => popUpRobar = false">X</button>
    </div>
    }

        @if (popUpCancelar)
        {
            <div style="position: fixed; color:#26282B ;top: 50%; right: 50%; background-color: lightblue; padding: 15px; border: 1px solid blue; border-radius: 5px; z-index: 1000;">
                @notificacionCancelar
                <button class="btn" @onclick="VolverAlMenu">Volver al menú principal</button>
            </div>
        }


        }
       

</div>

@code {
    [Parameter] public int PartidaId { get; set; }

    private List<EstadoCartaDTO> cartasJugador = new List<EstadoCartaDTO>();
    private int PerfilUsuarioId;
    private int UsuarioPartidaId;
    private int UsuarioPartidaIdRival;
    private int Mazo = 0;
    private List<EstadoCartaDTO> cartasMano = new List<EstadoCartaDTO>();
    private List<EstadoCartaDTO> cartasRival = new List<EstadoCartaDTO>();
    private List<EstadoCartaDTO> cartasEnCampo = new List<EstadoCartaDTO>();
    private List<EstadoCartaDTO> cartasEnCampoRival = new List<EstadoCartaDTO>();
    private EstadoCartaDTO? cartaSeleccionada = null;
    private HubConnection? hubConnection;
    private int Cementerio = 0;
    private TurnoDTO? turnoActual; 
    private TurnoDTO? turnoNuevo = null;
    private int ultimoNumeroTurno = 1;
    private bool roboCarta= false;
    private bool existeRoboInicial = true;
    private bool popUpRobar = false;
    private bool popUpCancelar = false;
    private bool terminaronTurno = false;
    private string btnTerminarTurnoText = "Terminar Turno";
    private string notificacionCancelar = string.Empty;
    private int vidaRival = 3;
    private string nombreRival = string.Empty;
    private string nombreJugador = string.Empty;


    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var idStr = await js.InvokeAsync<string>("localStorage.getItem", "UsuarioId");
            if (!string.IsNullOrEmpty(idStr) && int.TryParse(idStr, out var id))
            {
                Sesion.UsuarioId = id;
                await CargarPartida();
                nombreJugador = await js.InvokeAsync<string>("localStorage.getItem", "NombreUsuario");

                hubConnection = new HubConnectionBuilder()
                 .WithUrl("https://localhost:7192/juegoHub")
                 .WithAutomaticReconnect()
                 .Build();

                hubConnection.On("ActualizarPartida", async () =>
                {
                    await InvokeAsync(Actualizar);
                });

                hubConnection.On<string>("RecibirNotificacionRechazo", (mensaje) =>
                {
                    InvokeAsync(() =>
                    {
                        popUpCancelar = true;
                        notificacionCancelar= mensaje;
                        StateHasChanged();
                    });

                });

                await hubConnection.StartAsync();


                if (hubConnection != null)
                {
                    await hubConnection.InvokeAsync("UnirsePartida", PartidaId);
                }

            }

            var httpRespIdRival = await http.Get<int>($"api/Juego/usuarioPartida/{UsuarioPartidaId}");
            if (!httpRespIdRival.Error && httpRespIdRival != null)
            {
                UsuarioPartidaIdRival = httpRespIdRival.Respuesta;
                var httpRespNombreRival = await http.Get<MensajeRespuestaDTO>($"api/UsuarioPartida/nombre/{UsuarioPartidaIdRival}");
                if(!httpRespNombreRival.Error && httpRespNombreRival.Respuesta != null)
                {
                    nombreRival = httpRespNombreRival.Respuesta.Mensaje;
                }
            }
            
            StateHasChanged();
        }
    }

    private void SeleccionarCarta(EstadoCartaDTO carta)
    {
        cartaSeleccionada = carta;
        StateHasChanged();
    }

    private async Task ColocarCarta(string campoDestino)
    {
        if (turnoActual.Fase == "Colocación")
        {

            if (cartaSeleccionada == null)
                return;

            cartaSeleccionada.Posicion = campoDestino;

            var resp = await httpClient.PutAsync($"api/Juego/estadoCarta/colocarEnCampo/{UsuarioPartidaId}/{cartaSeleccionada.Id}/{campoDestino}/{turnoActual.Id}", null);

            cartaSeleccionada = null;
            if (hubConnection != null)
            {
                await hubConnection.InvokeAsync("ActualizarPartida", PartidaId);
            }

            StateHasChanged();
        }

    }

    private async Task CargarPartida()
    {
        try
        {

            var httpRespPerfil = await http.Get<PerfilUsuarioDTO>($"api/PerfilUsuario/ObtenerPerfilUsuarioId/{Sesion.UsuarioId}");
            if (!httpRespPerfil.Error && httpRespPerfil.Respuesta != null)
            {
                PerfilUsuarioId = httpRespPerfil.Respuesta.Id;
            }
            else
            {
                Console.WriteLine("Error al obtener el perfil del usuario.");
            }

            var httpRespUsuarioPartida = await http.Get<int>($"api/Juego/buscarUsuarioPartida/{PerfilUsuarioId}");
            if (!httpRespUsuarioPartida.Error)
            {
                UsuarioPartidaId = httpRespUsuarioPartida.Respuesta;
            }
            else
            {
                Console.WriteLine("Error al obtener el perfil del usuario.");
            }

            var tipoMazo = Uri.EscapeDataString("Mazo Inicial");

            var url = $"api/Juego/CrearEstadosCartas/{UsuarioPartidaId}/{tipoMazo}";
            var httpResp = await http.Post<object, MensajeRespuestaDTO>(url, new { });
            if (httpResp.Error)
            {
                Console.WriteLine("Error al crear el mazo inicial.");
            }

            await ExisteRoboInicial();

            await ObtenerTurnoActual();

            await CartasDelJugador();

            await CartasDelRival();

            await CartasEnMano();

            await CartasEnMazo();

            await CartasEnCementerio();

            CartasEnCampo();

            CartasEnCampoRival();
        }
        catch (Exception e)
        {
            Console.WriteLine($"Error al inicializar la partida: {e.Message}");
        }
    }

    private async Task CartasEnMano()
    {
        try
        {
            var httpResp = await http.Get<List<EstadoCartaDTO>>($"api/Juego/estadoCarta/filtrarPosicion/{UsuarioPartidaId}/Mano");
            if(!httpResp.Error && httpResp.Respuesta != null)
            {
                cartasMano = httpResp.Respuesta;
            }
            else
            {
                Console.WriteLine("Error al obtener las cartas en mano.");
            }
        }
        catch (Exception e)
        {
            Console.WriteLine($"Error al obtener las cartas en mano: {e.Message}");
        }
    }


    private void CartasEnCampo()
    {
        cartasEnCampo =  cartasJugador
                    .Where(c => c.Posicion == "Campo1" || c.Posicion == "Campo2" || c.Posicion == "Campo3")
                    .OrderBy(c =>
                        c.Posicion switch
                        {
                            "Campo1" => 1,
                            "Campo2" => 2,
                            "Campo3" => 3,
                            _ => 4
                        }).ToList();
    }

    private void CartasEnCampoRival()
    {
        cartasEnCampoRival = cartasRival
                    .Where(c => c.Posicion == "Campo1" || c.Posicion == "Campo2" || c.Posicion == "Campo3")
                    .OrderBy(c =>
                        c.Posicion switch
                        {
                            "Campo1" => 1,
                            "Campo2" => 2,
                            "Campo3" => 3,
                            _ => 4
                        }).ToList();
    }


    private async Task RobarCarta()
    {
        ultimoNumeroTurno = turnoActual!.Numero;
        if(roboCarta==false && (turnoActual.Fase == "Robo Inicial" || turnoActual.Fase == "Robo"))
        { 
            try
            {
                var httpResp = await httpClient.PutAsync($"api/Juego/estadoCarta/robarCarta/{UsuarioPartidaId}/{turnoActual.Id}", null);
                if (httpResp.IsSuccessStatusCode)
                {

                    roboCarta = true;
                    await CrearTurno("Colocación");
                    await Actualizar(); 

                }
                else
                {
                    Console.WriteLine("Error al robar.");
                }

            }
            catch (Exception e)
            {
                Console.WriteLine($"Error al robar carta: {e.Message}");
            } 
        } 
        else{
            Console.WriteLine("Ya has robado una carta este turno.");
            popUpRobar = true;
        }

    }

    private async Task CartasEnMazo()
    {
        try
        {
            var httpResp = await http.Get<List<EstadoCartaDTO>>($"api/Juego/estadoCarta/filtrarPosicion/{UsuarioPartidaId}/Mazo");
            if (!httpResp.Error && httpResp.Respuesta != null)
            {
                Mazo = httpResp.Respuesta.Count();

            }
            else
            {
                Console.WriteLine("Error al obtener las cartas en el mazo.");
            }
        }
        catch (Exception e)
        {
            Console.WriteLine($"Error al obtener las cartas en el mazo: {e.Message}");
        }
    }

    private async Task CartasEnCementerio()
    {
        try
        {
            var httpResp = await http.Get<List<EstadoCartaDTO>>($"api/Juego/estadoCarta/filtrarPosicion/{UsuarioPartidaId}/Cementerio");
            if (!httpResp.Error && httpResp.Respuesta != null)
            {
                Cementerio = httpResp.Respuesta.Count();

            }
            else
            {
                Console.WriteLine("Error al obtener las cartas en el cementerio.");
            }
        }
        catch (Exception e)
        {
            Console.WriteLine($"Error al obtener las cartas en el cementerio: {e.Message}");
        }
    }

    private async Task CartasDelJugador()
    {
        try 
        { 
            var httpResp = await http.Get<List<EstadoCartaDTO>>($"api/Juego/estadoCarta/usuario/{UsuarioPartidaId}");
            if (!httpResp.Error && httpResp.Respuesta != null)
            {
                cartasJugador = httpResp.Respuesta;
            }
            else
            {
                Console.WriteLine("Error al obtener las cartas.");
            } 
        }
        catch (Exception e)
        {
            Console.WriteLine($"Error al obtener las cartas: {e.Message}");
        }

    }

    private async Task CartasDelRival()
    {
        try
        {
            var httpRespRivalId = await http.Get<int>($"api/Juego/usuarioPartida/{UsuarioPartidaId}");
            if (!httpRespRivalId.Error)
            {
                var rivalId = httpRespRivalId.Respuesta;
                var httpResp = await http.Get<List<EstadoCartaDTO>>($"api/Juego/estadoCarta/usuario/{rivalId}");
                if (!httpResp.Error && httpResp.Respuesta != null)
                {
                    cartasRival = httpResp.Respuesta;
                }
                else
                {
                    Console.WriteLine("Error al obtener las cartas.");
                }
            }
            else
            {
                Console.WriteLine("Error al obtener el ID del rival.");
            }
        }
        catch (Exception e)
        {
            Console.WriteLine($"Error al obtener las cartas del rival: {e.Message}");
        }
    }

    private async Task Actualizar()
    {
        await CartasDelJugador();
        await CartasDelRival();
        await CartasEnMazo();
        await CartasEnMano();
        await CartasEnCementerio();
        CartasEnCampo();
        CartasEnCampoRival();
        await ObtenerTurnoActual();
        await RevisarDerrota();
        await VidaRival();
        StateHasChanged();
    }

    private async Task CrearTurno(string fase)
    {
        var crearTurnoDTO = new TurnoCrearDTO
        {
            UsuarioPartidaID = UsuarioPartidaId,
            Numero = ultimoNumeroTurno,
            Fase = fase
        };

        var response = await httpClient.PostAsJsonAsync("api/Juego/turno", crearTurnoDTO);

        if (response.IsSuccessStatusCode)
        {
            turnoNuevo = await response.Content.ReadFromJsonAsync<TurnoDTO>();
            StateHasChanged();
        }
        else
        {
            Console.WriteLine($"Error al crear turno: {response.StatusCode}");
        }


    }


    private async Task ObtenerTurnoActual()
    {
        var response = await httpClient.GetAsync($"api/Juego/turno/ultimo/{UsuarioPartidaId}");
        if (response.IsSuccessStatusCode)
        {
            turnoActual = await response.Content.ReadFromJsonAsync<TurnoDTO>();
            StateHasChanged();
        }
        else
        {
            Console.WriteLine($"Error al obtener el turno actual: {response.StatusCode}");
        }
    }

    private async Task ExisteRoboInicial()
    {
        var response = await httpClient.GetAsync($"api/Juego/turno/existeRoboInicial/{UsuarioPartidaId}");
        if (response.IsSuccessStatusCode)
        {
            existeRoboInicial = await response.Content.ReadFromJsonAsync<bool>();

            if(!existeRoboInicial)
            {
                await CrearTurno("Robo Inicial");
            }
        }
        else
        {
            Console.WriteLine($"Error al verificar el turno de robo inicial: {response.StatusCode}");
        }
    }


    private async Task  PresionoTerminarTurno()
    {
        await CrearTurno("Batalla");
        btnTerminarTurnoText = "Esperando al Rival...";
        terminaronTurno = true;

        await InvokeAsync(StateHasChanged);

        while (terminaronTurno == true)
        {
            await Task.Delay(1000);
            var response = await httpClient.
            GetAsync($"api/Juego/turno/presionoTerminarTurno/{UsuarioPartidaIdRival}/{turnoActual.Numero}/{"Batalla"}");

            var isTrue = await response.Content.ReadFromJsonAsync<bool>();
            if (response.IsSuccessStatusCode && isTrue)
            {
                terminaronTurno = false;
                btnTerminarTurnoText = "Terminar Turno";
                await Actualizar();
                if(UsuarioPartidaId < UsuarioPartidaIdRival)
                {
                    await Task.Delay(300);
                }
                var url = $"api/Juego/batalla/{PartidaId}/{turnoActual.Id}";
                var httpRespBatalla = await http.Post<object, List<EventoDTO>>(url, new { });
                roboCarta = false;
                ultimoNumeroTurno += 1;
                var listaEventos = httpRespBatalla.Respuesta;

                foreach (var evento in httpRespBatalla.Respuesta)
                {
                    await js.InvokeVoidAsync("animarCarta.atacar", evento.Origen);
                    await Task.Delay(500);
                    await js.InvokeVoidAsync("animarCarta.atacada", evento.Destino);
                    await Task.Delay(500);
                }
                
                await CrearTurno("Robo");
                
                await Actualizar();
            }

        }
    }

    private async Task CancelarPartida()
    {

        var httpResp = await http.Post<int, MensajeRespuestaDTO>("api/Juego/cancelarPartida/", PerfilUsuarioId);

        if (!httpResp.Error)
        {
            await hubConnection!.InvokeAsync("NotificarRechazoPartida", PartidaId, $"El usuario {nombreJugador} se ha rendido");
        }
        else
        {
            notificacionCancelar = "Error al rechazar la partida.";
        }
    }

    private void VolverAlMenu()
    {
        popUpCancelar = false;
        navHttp.NavigateTo("/menuPrincipal");
    }

    private async Task RevisarDerrota()
    {
        var httpResp = await http.Get<bool>($"api/Juego/revisarDerrota/{UsuarioPartidaId}");
        if (!httpResp.Error && httpResp.Respuesta)
        {
            var httpRespDerrota = await http.Post<int, MensajeRespuestaDTO>("api/Juego/cancelarPartida/", PerfilUsuarioId);

            if (!httpRespDerrota.Error)
            {
                await hubConnection!.InvokeAsync("NotificarRechazoPartida", PartidaId, $"El usuario {nombreJugador} ha perdido la partida");
            }
        }
    }

    private async Task VidaRival()
    {
        var httpResp = await http.Get<int>($"api/Juego/cartasPerdidas/{UsuarioPartidaIdRival}");

        if(!httpResp.Error)
        {
            vidaRival = 3 - httpResp.Respuesta;
        }
    }

}